pipeline {
    agent {
       node {
           label 'windows-agent-01'
       }
    }

    stages {

        stage('Build') {
            steps {
                echo 'Building..'
                git branch: 'master',
                    url: 'https://github.com/richard3d/LSystem'
                bat ''' 
                    "C:\\Program Files\\Unity\\Editor\\Unity.exe" -quit -batchmode -projectPath "%WORKSPACE%" -buildWindows64Player "C:\\bin\\richie.exe" -logFile "%WORKSPACE%\\%BUILD_NUMBER%.out"
                    type "%WORKSPACE%\\%BUILD_NUMBER%.out"
                ''' 

                script {
                    def server = Artifactory.newServer('http://10.0.0.11:8082/artifactory', 'admin', 'password')

                    def uploadSpec = """{
                     "files": [
                      {
                          "pattern": "C:/bin/*.exe",
                          "target": "unity/"
                      }
                      ]
                    }"""

                    def buildInfo = server.upload(uploadSpec)
                    //server.publishBuildInfo buildInfo
                }   

            }   
        }
   
        stage('Test') {
            steps {
                echo 'Testing..'
            }   
        }

        stage('Deploy') {
            steps {
                echo 'Deploying....'
            }   
        }

        stage('Telemetry') {
            steps {
                echo 'Write results to CSV for Tableau'

                script {
                   def file1 = new File("%WORKSPACE%\%BUILD_NUMBER%-results.txt")

                   file1.write "Build No.,Build Result,Build Date,Jenkins URL"
                   file1.append "%BUILD_NUMBER%,1,%BUILD_DATE%,%JENKINS_URL%"
                   file1.append "%BUILD_NUMBER%,2,%BUILD_DATE%,%JENKINS_URL%"
                   file1.append "%BUILD_NUMBER%,0,%BUILD_DATE%,%JENKINS_URL%"
                   file1.append "%BUILD_NUMBER%,3,%BUILD_DATE%,%JENKINS_URL%"
  
                   def server = Artifactory.newServer('http://10.0.0.11:8082/artifactory', 'admin', 'password')

                   def uploadSpec = """{
                    "files": [
                     {
                         "pattern": "%WORKSPACE%/*txt",
                         "target": "unity/results/"
                     }
                     ]
                   }"""

                   def buildInfo = server.upload(uploadSpec)
                }   
            }   
        }   
    }   
}

